<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>runvoy Logs - {execution_id}</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Monaco', 'Courier New', monospace;
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 20px;
        }
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding: 15px;
            background: #2d2d2d;
            border-radius: 5px;
        }
        .status {
            padding: 5px 12px;
            border-radius: 3px;
            font-weight: bold;
        }
        .status.RUNNING { background: #ffa500; color: #000; }
        .status.SUCCEEDED { background: #4caf50; color: #000; }
        .status.FAILED { background: #f44336; }
        .status.STOPPED { background: #9e9e9e; color: #000; }
        .log-container {
            background: #1e1e1e;
            border: 1px solid #3e3e3e;
            border-radius: 5px;
            padding: 15px;
            height: calc(100vh - 150px);
            overflow-y: auto;
            font-size: 13px;
            line-height: 1.5;
        }
        .log-line { white-space: pre-wrap; }
        .controls {
            margin-bottom: 15px;
            display: flex;
            gap: 10px;
        }
        button {
            padding: 8px 16px;
            background: #007acc;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
        }
        button:hover:not(:disabled) { background: #005a9e; }
        button:disabled {
            background: #555;
            color: #999;
            cursor: not-allowed;
        }
        .api-key-input {
            padding: 8px;
            background: #2d2d2d;
            border: 1px solid #3e3e3e;
            color: #d4d4d4;
            border-radius: 3px;
            flex: 1;
        }

        /* ANSI color classes (subset) */
        .ansi-black { color: #000; }
        .ansi-red { color: #cd3131; }
        .ansi-green { color: #0dbc79; }
        .ansi-yellow { color: #e5e510; }
        .ansi-blue { color: #2472c8; }
        .ansi-magenta { color: #bc3fbc; }
        .ansi-cyan { color: #11a8cd; }
        .ansi-white { color: #e5e5e5; }
        .ansi-bright-black { color: #666; }
        .ansi-bright-red { color: #f14c4c; }
        /* ... more colors ... */
    </style>
</head>
<body>
    <div class="header">
        <div>
            <h2>Execution: <span id="exec-id">Loading...</span></h2>
            <small>Started: <span id="started-at">-</span></small>
        </div>
        <div class="status" id="status">-</div>
    </div>

    <div class="controls">
        <input
            type="password"
            id="api-key-input"
            class="api-key-input"
            placeholder="Enter API key (p_75LzCL...)"
        >
        <button onclick="saveApiKey()">Save API Key</button>
        <button id="play-pause-btn" onclick="togglePolling()">Pause</button>
        <button onclick="downloadLogs()">Download</button>
        <button onclick="clearLogs()">Clear</button>
    </div>

    <div id="log-container" class="log-container"></div>

    <script>
        // Configuration
        const API_ENDPOINT = 'https://zsbytrdog7wdvpbvtsktxohf4e0qwiav.lambda-url.us-east-2.on.aws'; // From CloudFormation output
        const POLL_INTERVAL = 5000; // 5 seconds

        // State
        let executionId = null;
        let apiKey = null;
        let lastLineNumber = 0; // Track last line number to only append new logs
        let pollingInterval = null;
        let isCompleted = false;
        let isPaused = false;

        // Initialize
        document.addEventListener('DOMContentLoaded', init);

        function init() {
            // Extract execution ID from URL query parameter
            const urlParams = new URLSearchParams(window.location.search);
            executionId = urlParams.get('execution_id') || urlParams.get('executionId');

            if (!executionId) {
                appendLog('[ERROR] Missing execution_id query parameter. Please provide ?execution_id=<id>\n');
                document.getElementById('exec-id').textContent = 'Missing execution ID';
                return;
            }

            // Load API key from localStorage
            apiKey = localStorage.getItem('runvoy_api_key');
            if (apiKey) {
                document.getElementById('api-key-input').value = '••••••••';
            }

            // Update UI
            document.getElementById('exec-id').textContent = executionId;
            updatePlayPauseButton();

            // Start fetching logs and status
            if (apiKey) {
                fetchStatus();
                fetchLogs();
                startPolling();
            } else {
                appendLog('[INFO] Please enter your API key to view logs\n');
            }
        }

        function saveApiKey() {
            const input = document.getElementById('api-key-input');
            const key = input.value;

            if (!key || key === '••••••••') {
                alert('Please enter a valid API key');
                return;
            }

            apiKey = key;
            localStorage.setItem('runvoy_api_key', key);
            input.value = '••••••••';

            // Start fetching
            fetchStatus();
            fetchLogs();
            startPolling();
        }

        async function fetchStatus() {
            if (!apiKey) return;

            try {
                const url = `${API_ENDPOINT}/api/v1/executions/${executionId}/status`;
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.details || 'Invalid API key');
                    }
                    if (response.status === 404) {
                        // Execution not found yet, keep trying
                        return;
                    }
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.details || `HTTP ${response.status}`);
                }

                const data = await response.json();

                // Update metadata
                if (data.started_at) {
                    // started_at is an ISO timestamp string from the API
                    document.getElementById('started-at').textContent = new Date(data.started_at).toLocaleString();
                }

                // Update status
                updateStatus(data.status);

                // Check if completed
                const terminalStatuses = ['SUCCEEDED', 'FAILED', 'STOPPED'];
                if (terminalStatuses.includes(data.status)) {
                    isCompleted = true;
                    stopPolling();
                    updatePlayPauseButton();
                    if (data.exit_code !== null && data.exit_code !== undefined) {
                        appendLog(`\n[INFO] Execution ${data.status} with exit code ${data.exit_code}\n`);
                    } else {
                        appendLog(`\n[INFO] Execution ${data.status}\n`);
                    }
                }
            } catch (error) {
                console.error('Failed to fetch status:', error);
                
                if (error.message.includes('Invalid API key') || error.message.includes('Unauthorized')) {
                    stopPolling();
                    localStorage.removeItem('runvoy_api_key');
                    document.getElementById('api-key-input').value = '';
                    appendLog(`\n[ERROR] Invalid API key. Please enter a valid key.\n`);
                }
            }
        }

        async function fetchLogs() {
            if (!apiKey) return;

            try {
                const url = `${API_ENDPOINT}/api/v1/executions/${executionId}/logs`;
                const response = await fetch(url, {
                    headers: {
                        'X-API-Key': apiKey
                    }
                });

                if (!response.ok) {
                    if (response.status === 401) {
                        const errorData = await response.json().catch(() => ({}));
                        throw new Error(errorData.details || 'Invalid API key');
                    }
                    if (response.status === 404) {
                        // Log stream doesn't exist yet, this is normal for new executions
                        return;
                    }
                    const errorData = await response.json().catch(() => ({}));
                    throw new Error(errorData.details || `HTTP ${response.status}`);
                }

                const data = await response.json();

                // Append new log events (only those after lastLineNumber)
                if (data.events && Array.isArray(data.events)) {
                    const newEvents = data.events.filter(event => event.line > lastLineNumber);
                    
                    if (newEvents.length > 0) {
                        // Sort by line number to ensure correct order
                        newEvents.sort((a, b) => a.line - b.line);
                        
                        for (const event of newEvents) {
                            appendLog(event.message);
                            lastLineNumber = Math.max(lastLineNumber, event.line);
                        }
                    }
                }
            } catch (error) {
                console.error('Failed to fetch logs:', error);
                
                // Only show error if it's not a 404 (which means logs don't exist yet)
                if (!error.message.includes('404')) {
                    appendLog(`\n[ERROR] Failed to fetch logs: ${error.message}\n`);
                }

                if (error.message.includes('Invalid API key') || error.message.includes('Unauthorized')) {
                    stopPolling();
                    localStorage.removeItem('runvoy_api_key');
                    document.getElementById('api-key-input').value = '';
                }
            }
        }

        function appendLog(text) {
            const container = document.getElementById('log-container');
            const parsed = parseAnsi(text);
            container.innerHTML += parsed;

            // Auto-scroll to bottom
            container.scrollTop = container.scrollHeight;
        }

        function parseAnsi(text) {
            // Simple ANSI parser (or use library like ansi-to-html)
            const ansiRegex = /\x1b\[(\d+)m/g;
            let result = text.replace(/&/g, '&amp;')
                            .replace(/</g, '&lt;')
                            .replace(/>/g, '&gt;');

            // Color mappings
            const colorMap = {
                '30': 'black', '31': 'red', '32': 'green', '33': 'yellow',
                '34': 'blue', '35': 'magenta', '36': 'cyan', '37': 'white',
                '90': 'bright-black', '91': 'bright-red', // ... etc
            };

            result = result.replace(ansiRegex, (match, code) => {
                if (code === '0') return '</span>'; // Reset
                const color = colorMap[code];
                return color ? `<span class="ansi-${color}">` : '';
            });

            return `<div class="log-line">${result}</div>`;
        }

        function updateStatus(status) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = status || '-';
            // Normalize status for CSS class (backend returns uppercase like RUNNING, SUCCEEDED, etc.)
            const statusClass = status ? status.toUpperCase() : '';
            statusEl.className = `status ${statusClass}`;
        }

        function startPolling() {
            if (pollingInterval || isPaused) return;
            pollingInterval = setInterval(() => {
                if (!isCompleted && !isPaused) {
                    fetchStatus();
                    fetchLogs();
                }
            }, POLL_INTERVAL);
            updatePlayPauseButton();
        }

        function stopPolling() {
            if (pollingInterval) {
                clearInterval(pollingInterval);
                pollingInterval = null;
            }
            updatePlayPauseButton();
        }

        function togglePolling() {
            if (isPaused) {
                // Resume polling
                isPaused = false;
                if (!isCompleted) {
                    startPolling();
                    // Immediately fetch once when resuming
                    fetchStatus();
                    fetchLogs();
                }
            } else {
                // Pause polling
                isPaused = true;
                stopPolling();
            }
            updatePlayPauseButton();
        }

        function updatePlayPauseButton() {
            const btn = document.getElementById('play-pause-btn');
            if (btn) {
                if (isCompleted) {
                    btn.textContent = 'Completed';
                    btn.disabled = true;
                } else if (isPaused) {
                    btn.textContent = 'Resume';
                    btn.disabled = false;
                } else {
                    btn.textContent = 'Pause';
                    btn.disabled = false;
                }
            }
        }

        function downloadLogs() {
            const container = document.getElementById('log-container');
            const text = container.innerText;
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `runvoy-${executionId}.log`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function clearLogs() {
            if (confirm('Clear log display? (logs are still stored in CloudWatch)')) {
                document.getElementById('log-container').innerHTML = '';
                lastLineNumber = 0;
            }
        }
    </script>
</body>
</html>