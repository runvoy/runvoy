AWSTemplateFormatVersion: '2010-09-09'
Description: 'runvoy - S3 cross-region replication setup (deploy to primary region only)'

Parameters:
  ProjectName:
    Type: String
    Default: runvoy
    Description: Name prefix for resources

  ReplicationTargetRegions:
    Type: CommaDelimitedList
    Description: Comma-separated list of regions to replicate to (excludes primary region us-east-1)

Resources:
  # IAM role for S3 replication
  ReplicationRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: s3.amazonaws.com
            Action: 'sts:AssumeRole'
      Policies:
        - PolicyName: S3ReplicationPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:GetReplicationConfiguration'
                  - 's3:ListBucket'
                Resource: !Sub 'arn:aws:s3:::${ProjectName}-releases-${AWS::Region}'
              - Effect: Allow
                Action:
                  - 's3:GetObjectVersionForReplication'
                  - 's3:GetObjectVersionAcl'
                Resource: !Sub 'arn:aws:s3:::${ProjectName}-releases-${AWS::Region}/*'
              - Effect: Allow
                Action:
                  - 's3:ReplicateObject'
                  - 's3:ReplicateDelete'
                Resource: !Sub 'arn:aws:s3:::${ProjectName}-releases-*/*'

  # Apply replication configuration to the primary bucket
  ApplyReplicationConfiguration:
    Type: AWS::CloudFormation::CustomResource
    Properties:
      ServiceToken: !GetAtt ReplicationLambda.Arn
      ProjectName: !Ref ProjectName
      PrimaryRegion: !Ref 'AWS::Region'
      TargetRegions: !Join [',', !Ref ReplicationTargetRegions]
      RoleArn: !GetAtt ReplicationRole.Arn

  # Lambda function to configure replication
  ReplicationLambdaRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: lambda.amazonaws.com
            Action: 'sts:AssumeRole'
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/service-role/AWSLambdaBasicExecutionRole
      Policies:
        - PolicyName: S3ReplicationConfigPolicy
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - 's3:ListAllMyBuckets'
                Resource: '*'
              - Effect: Allow
                Action:
                  - 's3:PutReplicationConfiguration'
                  - 's3:GetReplicationConfiguration'
                  - 's3:DeleteReplicationConfiguration'
                  - 's3:HeadBucket'
                  - 's3:GetBucketVersioning'
                  - 's3:GetBucketLocation'
                  - 's3:ListBucket'
                Resource:
                  - !Sub 'arn:aws:s3:::${ProjectName}-releases-*'
                  - !Sub 'arn:aws:s3:::${ProjectName}-releases-*/*'
              - Effect: Allow
                Action:
                  - 'iam:PassRole'
                Resource: !GetAtt ReplicationRole.Arn

  ReplicationLambda:
    Type: AWS::Lambda::Function
    Properties:
      FunctionName: !Sub '${ProjectName}-replication-lambda'
      Runtime: python3.11
      Role: !GetAtt ReplicationLambdaRole.Arn
      Handler: index.handler
      Timeout: 300
      Code:
        ZipFile: |
          import json
          import boto3
          import urllib.request
          import urllib.error

          def send_response(event, context, response_status, response_data, physical_resource_id=None):
              response_url = event['ResponseURL']
              response_body = json.dumps({
                  'Status': response_status,
                  'Reason': f'See the details in CloudWatch Log Stream: {context.log_stream_name}',
                  'PhysicalResourceId': physical_resource_id or context.log_stream_name,
                  'StackId': event['StackId'],
                  'RequestId': event['RequestId'],
                  'LogicalResourceId': event['LogicalResourceId'],
                  'Data': response_data
              }).encode('utf-8')

              req = urllib.request.Request(
                  response_url,
                  data=response_body,
                  headers={'Content-Length': str(len(response_body))},
                  method='PUT'
              )

              try:
                  with urllib.request.urlopen(req) as response:
                      pass
              except urllib.error.HTTPError as e:
                  print(f'Failed to send response: HTTP {e.code} {e.reason}')
              except Exception as e:
                  print(f'Failed to send response: {str(e)}')

          def handler(event, context):
              try:
                  request_type = event['RequestType']
                  project_name = event['ResourceProperties']['ProjectName']
                  primary_region = event['ResourceProperties']['PrimaryRegion']
                  target_regions = event['ResourceProperties']['TargetRegions'].split(',')
                  role_arn = event['ResourceProperties']['RoleArn']

                  bucket_name = f'{project_name}-releases-{primary_region}'

                  s3_client = boto3.client('s3', region_name=primary_region)

                  if request_type == 'Delete':
                      try:
                          s3_client.delete_bucket_replication(Bucket=bucket_name)
                          print(f'Deleted replication configuration for {bucket_name}')
                      except s3_client.exceptions.NoSuchBucket:
                          print(f'Bucket {bucket_name} does not exist, skipping replication deletion')
                      except Exception as e:
                          print(f'Error deleting replication config (may not exist): {str(e)}')
                      send_response(event, context, 'SUCCESS', {}, bucket_name)
                      return

                  # Verify primary bucket exists using GetBucketLocation (more reliable)
                  try:
                      location = s3_client.get_bucket_location(Bucket=bucket_name)
                      print(f'Primary bucket {bucket_name} exists in region {location.get("LocationConstraint", "us-east-1")}')
                  except s3_client.exceptions.ClientError as e:
                      error_code = e.response['Error']['Code']
                      if error_code == '404' or error_code == 'NoSuchBucket':
                          raise Exception(f'Primary bucket {bucket_name} does not exist. Please create it first.')
                      elif error_code == '403' or error_code == 'AccessDenied':
                          raise Exception(f'Access denied when checking primary bucket {bucket_name}. Check IAM permissions for s3:GetBucketLocation and s3:HeadBucket on bucket arn:aws:s3:::{bucket_name}.')
                      raise Exception(f'Error checking primary bucket {bucket_name}: {error_code} - {e.response.get("Error", {}).get("Message", str(e))}')

                  # Verify target buckets exist
                  for region in target_regions:
                      target_bucket = f'{project_name}-releases-{region}'
                      target_s3 = boto3.client('s3', region_name=region)
                      try:
                          # Try GetBucketLocation first as it's more reliable for cross-region checks
                          try:
                              location = target_s3.get_bucket_location(Bucket=target_bucket)
                              print(f'Target bucket {target_bucket} exists in region {location.get("LocationConstraint", "us-east-1")}')
                          except target_s3.exceptions.ClientError:
                              # Fallback to head_bucket if GetBucketLocation fails
                              target_s3.head_bucket(Bucket=target_bucket)
                              print(f'Target bucket {target_bucket} exists')
                      except target_s3.exceptions.ClientError as e:
                          error_code = e.response['Error']['Code']
                          if error_code == '404':
                              raise Exception(f'Target bucket {target_bucket} does not exist. Please create it first.')
                          elif error_code == '403':
                              raise Exception(f'Access denied when checking target bucket {target_bucket}. Check IAM permissions for s3:HeadBucket and s3:GetBucketLocation on bucket.')
                          raise Exception(f'Error checking target bucket {target_bucket}: {error_code} - {e.response.get("Error", {}).get("Message", str(e))}')

                  # Build replication rules
                  rules = []
                  for idx, region in enumerate(target_regions, start=1):
                      rules.append({
                          'ID': f'ReplicateTo{region.replace("-", "")}',
                          'Status': 'Enabled',
                          'Priority': idx,
                          'DeleteMarkerReplication': {
                              'Status': 'Enabled'
                          },
                          'Filter': {
                              'Prefix': ''
                          },
                          'Destination': {
                              'Bucket': f'arn:aws:s3:::{project_name}-releases-{region}',
                              'StorageClass': 'STANDARD'
                          }
                      })

                  # Apply replication configuration
                  replication_config = {
                      'Role': role_arn,
                      'Rules': rules
                  }

                  print(f'Configuring replication for {bucket_name} to {len(target_regions)} regions')
                  s3_client.put_bucket_replication(
                      Bucket=bucket_name,
                      ReplicationConfiguration=replication_config
                  )

                  message = f'Replication configured for {bucket_name} to {", ".join(target_regions)}'
                  print(message)
                  send_response(event, context, 'SUCCESS', {
                      'Message': message
                  }, bucket_name)
              except Exception as e:
                  error_msg = str(e)
                  print(f'Error: {error_msg}')
                  send_response(event, context, 'FAILED', {
                      'Message': error_msg
                  })

Outputs:
  ReplicationStatus:
    Description: Status of replication configuration
    Value: !Sub 'Replication configured for ${ProjectName}-releases-${AWS::Region} to ${AWS::Region}'
