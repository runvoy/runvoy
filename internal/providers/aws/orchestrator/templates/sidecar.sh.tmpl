set -e

{{- $secretVarNames := .SecretVarNames }}
{{- $allVarNames := .AllVarNames }}
{{- $hasSecretVars := gt (len $secretVarNames) 0 }}
{{- $hasVars := gt (len $allVarNames) 0 }}
{{- if $hasVars }}
  echo '### {{ .ProjectName }} sidecar: Creating .env file from user environment variables'
  ENV_FILE_PATH="${RUNVOY_SHARED_VOLUME_PATH}/.env"
  rm -f "${ENV_FILE_PATH}"
  {{- if $hasSecretVars }}
  # Process all variables by iterating through known names (avoids using env | grep which could expose secrets)
  {{- range $allVarNames }}
  if [ -n "${RUNVOY_USER_{{ . }}+x}" ]; then
    printf '%s=%s\n' "{{ . }}" "${RUNVOY_USER_{{ . }}}" >> "${ENV_FILE_PATH}" 2>/dev/null
  fi
  {{- end }}
  {{- else }}
  # No secrets detected, safe to use env | grep for all variables
  env | grep '^RUNVOY_USER_' | while IFS='=' read -r key value; do
    actual_key="${key#RUNVOY_USER_}"
    printf '%s=%s\n' "${actual_key}" "${value}" >> "${ENV_FILE_PATH}"
  done
  {{- end }}
  if [ -f "${ENV_FILE_PATH}" ]; then
    echo '### {{ .ProjectName }} sidecar: .env file created with' "$(wc -l < "${ENV_FILE_PATH}")" 'variables at' "${ENV_FILE_PATH}"
  else
    echo '### {{ .ProjectName }} sidecar: No .env file created'
  fi
{{- else }}
  echo '### {{ .ProjectName }} sidecar: No RUNVOY_USER_* variables found, skipping .env creation'
{{- end }}

{{- if .HasGitRepo }}
apk add --no-cache git
GIT_REF=${GIT_REF:-{{ .DefaultGitRef }}}
CLONE_PATH=${RUNVOY_SHARED_VOLUME_PATH}/repo
echo '### {{ .ProjectName }} sidecar: Cloning ${GIT_REPO} (ref: ${GIT_REF})'
git clone --depth 1 --branch "${GIT_REF}" "${GIT_REPO}" "${CLONE_PATH}"
echo '### {{ .ProjectName }} sidecar: Clone completed successfully'
if [ -f "${RUNVOY_SHARED_VOLUME_PATH}/.env" ]; then
  cp "${RUNVOY_SHARED_VOLUME_PATH}/.env" "${CLONE_PATH}/.env"
  echo '### {{ .ProjectName }} sidecar: .env file copied to repo directory'
fi
ls -la "${CLONE_PATH}"
{{- else }}
echo '### {{ .ProjectName }} sidecar: No git repository specified, exiting'
{{- end }}

echo '### {{ .ProjectName }} sidecar: Sidecar completed successfully'
